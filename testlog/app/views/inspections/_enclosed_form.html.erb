<%= form_with model: @inspection,
             url: inspection_path(@inspection),
             method: :patch,
             local: false,
             html: {
               class: "inspection-enclosed-form",
               data: { autosave: "true", turbo_stream: true }
             } do |form| %>

  <%= form.fields_for :enclosed_assessment, (@inspection.enclosed_assessment || @inspection.build_enclosed_assessment) do |assessment_form| %>

    <div class="assessment-form enclosed-assessment">
      <h3><%= t('inspections.assessments.enclosed.title') %></h3>

      <!-- Exit Requirements Section -->
      <%= render 'form/fieldset', legend_key: 'exit_requirements', i18n_base: 'inspections.assessments.enclosed.fields', form: assessment_form do %>
        <div class="form-group">
          <%= render 'form/number', field: :exit_number, min: 0, step: 1 %>
          <%= render 'form/pass_fail', field: :exit_number_pass %>
          <%= render 'form/text_area', field: :exit_number_comment %>
        </div>

        <div class="form-group">
          <%= render 'form/pass_fail', field: :exit_visible_pass %>
          <%= render 'form/text_area', field: :exit_visible_comment %>
        </div>
      <% end %>

      <!-- Assessment Summary -->
      <% if @inspection.enclosed_assessment&.persisted? %>
        <div class="assessment-summary">
          <h4><%= t('inspections.assessments.enclosed.summary.title') %></h4>
          
          <div class="compliance-status">
            <strong><%= t('inspections.assessments.enclosed.summary.completion') %>:</strong>
            <span class="completion-percentage"><%= @inspection.enclosed_assessment.completion_percentage %>%</span>
          </div>

          <div class="safety-status">
            <strong><%= t('inspections.assessments.enclosed.summary.safety_checks') %>:</strong>
            <span class="checks-count">
              <%= @inspection.enclosed_assessment.passed_checks_count %> / <%= @inspection.enclosed_assessment.safety_check_count %>
            </span>
          </div>

          <% if @inspection.enclosed_assessment.has_critical_failures? %>
            <div class="critical-failures text-danger">
              <strong><%= t('inspections.assessments.enclosed.summary.critical_failures') %>:</strong>
              <%= @inspection.enclosed_assessment.critical_failure_summary %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Safety Status -->
      <%= render 'form/assessment_status', assessment: @inspection.enclosed_assessment, i18n_base: 'inspections.assessments.enclosed' %>

      <%= render 'form/save_assessment' %>
    </div>
  <% end %>
<% end %>