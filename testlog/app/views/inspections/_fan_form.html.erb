<%= form_with model: @inspection,
             url: inspection_path(@inspection),
             method: :patch,
             local: false,
             html: {
               class: "inspection-fan-form",
               data: { autosave: "true", turbo_stream: true }
             } do |form| %>

  <%= form.fields_for :fan_assessment, (@inspection.fan_assessment || @inspection.build_fan_assessment) do |assessment_form| %>

    <div class="assessment-form fan-assessment">
      <h3><%= t('inspections.assessments.fan.title') %></h3>

      <!-- Blower Specifications Section -->
      <%= render 'form/fieldset', legend_key: 'blower_specifications', i18n_base: 'inspections.assessments.fan.fields', form: assessment_form do %>
        <div class="form-group">
          <%= render 'form/text_field', field: :blower_serial %>
        </div>
        
        <div class="form-group">
          <%= render 'form/text_area', field: :fan_size_comment %>
        </div>
      <% end %>

      <!-- Blower Safety Checks Section -->
      <%= render 'form/fieldset', legend_key: 'blower_safety_checks', i18n_base: 'inspections.assessments.fan.fields', form: assessment_form do %>
        <div class="blower-check-group">
          <%= render 'form/pass_fail', field: :blower_flap_pass %>
          <%= render 'form/text_area', field: :blower_flap_comment %>
        </div>

        <div class="blower-check-group">
          <%= render 'form/pass_fail', field: :blower_finger_pass %>
          <%= render 'form/text_area', field: :blower_finger_comment %>
        </div>

        <div class="blower-check-group">
          <%= render 'form/pass_fail', field: :blower_visual_pass %>
          <%= render 'form/text_area', field: :blower_visual_comment %>
        </div>
      <% end %>

      <!-- Electrical Safety Section -->
      <%= render 'form/fieldset', legend_key: 'electrical_safety', i18n_base: 'inspections.assessments.fan.fields', form: assessment_form do %>
        <div class="pat-testing-group">
          <%= render 'form/pass_fail', field: :pat_pass %>
          <%= render 'form/text_area', field: :pat_comment %>
        </div>
      <% end %>

      <!-- Assessment Summary -->
      <% if @inspection.fan_assessment&.persisted? %>
        <div class="fan-assessment-summary">
          <h4><%= t('inspections.assessments.fan.summary.title') %></h4>
          
          <div class="fan-safety-overview">
            <div class="blower-checks">
              <strong><%= t('inspections.assessments.fan.summary.blower_checks') %>:</strong>
              <% passed_checks = [@inspection.fan_assessment.blower_flap_pass, @inspection.fan_assessment.blower_finger_pass, @inspection.fan_assessment.blower_visual_pass].count(true) %>
              <% total_checks = 3 %>
              <span class="checks-count <%= passed_checks == total_checks ? 'text-success' : 'text-warning' %>">
                <%= passed_checks %> / <%= total_checks %>
              </span>
            </div>

            <div class="electrical-safety">
              <strong><%= t('inspections.assessments.fan.summary.electrical_safety') %>:</strong>
              <span class="<%= @inspection.fan_assessment.pat_pass ? 'text-success' : 'text-danger' %>">
                <%= @inspection.fan_assessment.pat_pass ? 
                    t('inspections.assessments.fan.status.pass') : 
                    t('inspections.assessments.fan.status.fail') %>
              </span>
            </div>

            <% if @inspection.fan_assessment.blower_serial.present? %>
              <div class="blower-details">
                <strong><%= t('inspections.assessments.fan.summary.blower_serial') %>:</strong>
                <span class="serial-number"><%= @inspection.fan_assessment.blower_serial %></span>
              </div>
            <% end %>
          </div>

          <!-- Critical Issues Alert -->
          <% failed_checks = [@inspection.fan_assessment.blower_flap_pass, @inspection.fan_assessment.blower_finger_pass, @inspection.fan_assessment.blower_visual_pass, @inspection.fan_assessment.pat_pass].any? { |check| check == false } %>
          <% if failed_checks %>
            <div class="fan-safety-issues text-danger">
              <strong><%= t('inspections.assessments.fan.summary.safety_issues') %>:</strong>
              <ul>
                <% if @inspection.fan_assessment.blower_flap_pass == false %>
                  <li><%= t('inspections.assessments.fan.issues.blower_flap') %></li>
                <% end %>
                <% if @inspection.fan_assessment.blower_finger_pass == false %>
                  <li><%= t('inspections.assessments.fan.issues.finger_guards') %></li>
                <% end %>
                <% if @inspection.fan_assessment.blower_visual_pass == false %>
                  <li><%= t('inspections.assessments.fan.issues.visual_damage') %></li>
                <% end %>
                <% if @inspection.fan_assessment.pat_pass == false %>
                  <li><%= t('inspections.assessments.fan.issues.pat_failure') %></li>
                <% end %>
              </ul>
            </div>
          <% else %>
            <div class="fan-safety-status text-success">
              <strong><%= t('inspections.assessments.fan.summary.overall_status') %>:</strong>
              <%= t('inspections.assessments.fan.summary.all_checks_passed') %>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Safety Status -->
      <%= render 'form/assessment_status', assessment: @inspection.fan_assessment, i18n_base: 'inspections.assessments.fan' %>

      <%= render 'form/save_assessment' %>
    </div>
  <% end %>
<% end %>