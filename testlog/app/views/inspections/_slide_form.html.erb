<%= form_with model: @inspection,
             url: inspection_path(@inspection),
             method: :patch,
             local: false,
             html: {
               class: "inspection-slide-form",
               data: { 
                 autosave: "true",
                 turbo_stream: true
               }
             } do |form| %>

  <%= form.fields_for :slide_assessment, (@inspection.slide_assessment || @inspection.build_slide_assessment) do |assessment_form| %>

    <div class="assessment-form slide-assessment">
      <%= render 'shared/page_header', title: t('inspections.assessments.slide.title') %>

      <!-- Safety Standards Reference -->
      <details class="safety-standards-reference">
        <summary>View Safety Standards</summary>
        <%= render 'shared/safety_standards/slide_safety_requirements' %>
      </details>

      <!-- Slide Measurements Section -->
      <%= render 'form/fieldset', legend_key: 'slide_measurements', i18n_base: 'inspections.assessments.slide.fields', form: assessment_form do %>
        <div class="form-group">
          <%= render 'form/number', field: :slide_platform_height %>
          <% if @inspection.slide_assessment&.slide_platform_height.present? %>
            <div class="safety-standards-info">
              <strong>EN 14960:2019 Wall Height Requirements:</strong>
              <% platform_height = @inspection.slide_assessment.slide_platform_height %>
              <% if platform_height < 0.6 %>
                No containing walls required
              <% elsif platform_height <= 3.0 %>
                Walls must be at least <%= platform_height %>m (equal to platform height)
              <% elsif platform_height <= 6.0 %>
                Walls must be at least <%= (platform_height * 1.25).round(2) %>m (1.25x platform height)
              <% else %>
                Walls must be at least <%= (platform_height * 1.25).round(2) %>m + permanent roof required
              <% end %>
            </div>
          <% end %>
        </div>
        <%= render 'form/number', field: :slide_wall_height %>

        <div class="form-group">
          <%= render 'form/number', field: :runout_value %>
          <% if @inspection.slide_assessment&.persisted? && @inspection.slide_assessment.slide_platform_height.present? %>
            <div class="safety-standards-info">
              <strong>EN 14960:2019 Requirement:</strong> 
              Minimum runout <%= @inspection.slide_assessment.required_runout_length&.round(2) %>m
              (50% of platform height or 300mm minimum)
            </div>
            <div class="runout-status <%= @inspection.slide_assessment.meets_runout_requirements? ? 'text-success' : 'text-danger' %>">
              <%= @inspection.slide_assessment.runout_compliance_status %>
            </div>
          <% end %>
        </div>

        <%= render 'form/number', field: :slide_first_metre_height %>
        <%= render 'form/number', field: :slide_beyond_first_metre_height %>
        <%= render 'form/checkbox', field: :slide_permanent_roof %>
      <% end %>

      <!-- Safety Checks Section -->
      <%= render 'form/fieldset', legend_key: 'safety_checks', i18n_base: 'inspections.assessments.slide.fields', form: assessment_form do %>
        <%= render 'form/pass_fail', field: :clamber_netting_pass %>
        <%= render 'form/pass_fail', field: :runout_pass %>
        <%= render 'form/pass_fail', field: :slip_sheet_pass %>
      <% end %>

      <!-- Comments Section -->
      <%= render 'form/comment', field: :slide_platform_height_comment %>

      <!-- Safety Status -->
      <%= render 'form/assessment_status', assessment: @inspection.slide_assessment, i18n_base: 'inspections.assessments.slide' %>

      <%= render 'form/save_assessment' %>
    </div>
  <% end %>
<% end %>
