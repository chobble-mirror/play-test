<%
  # Get i18n_base from explicit parameter or from parent section wrapper
  i18n_base = local_assigns[:i18n_base] || @_current_i18n_base
  
  # Determine legend text
  if local_assigns[:legend]
    legend_text = local_assigns[:legend]
  elsif local_assigns[:legend_key] && i18n_base
    # Remove .fields suffix if present to get to sections level
    sections_base = i18n_base.sub(/\.fields$/, '')
    legend_text = t("#{sections_base}.sections.#{local_assigns[:legend_key]}", 
                    default: local_assigns[:legend_key].to_s.humanize)
  else
    legend_text = local_assigns[:legend_key]&.to_s&.humanize || "Section"
  end
  
  # Form fieldset options
  css_class ||= "form-section"
%>

<fieldset class="<%= css_class %>">
  <% if legend_text.present? %>
    <legend><%= legend_text %></legend>
  <% end %>
  <%= yield %>
</fieldset>